<!DOCTYPE html>
<html>
<head>
    <title>FeatureProfile</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",componentCls:"app",scopeType:"release",settingsScope:"project",config:{defaultSettings:{includeBefore:0,includeAfter:0,costPerPoint:200,truncateStringLength:20,rotateLabels:!1}},layout:"fit",getSettingsFields:function(){return[{name:"costPerPoint",label:"Cost per Point",xtype:"rallynumberfield"},{name:"includeBefore",label:"Include Previous Releases",xtype:"rallynumberfield"},{name:"includeAfter",label:"Include Subsequent Releases",xtype:"rallynumberfield"},{name:"truncateStringLength",label:"Truncate Feature Names Length",xtype:"rallynumberfield"},{name:"rotateLabels",label:"Rotate Labels",xtype:"rallycheckboxfield"}]},addContent:function(scope){console.log("addContent");var me=this;Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,remoteFilter:!1,model:"TypeDefinition",sorters:[{property:"Ordinal",direction:"Desc"}],filters:[{property:"Parent.Name",operator:"=",value:"Portfolio Item"},{property:"Creatable",operator:"=",value:"true"}],listeners:{load:function(store,recs){console.log("load:arguments",arguments),me.piTypes={},Ext.Array.each(recs,function(type){me.piTypes[type.get("Ordinal")+""]=type.get("TypePath")}),me.featureField=me.piTypes["0"].split("/")[1],me.doit(scope)},scope:me}})},onScopeChange:function(scope){var me=this;_.isUndefined(me.piTypes)?me.addContent(scope):me.doit(scope)},doit:function(scope){console.log("onScopeChange",scope);var me=this;me._queryForReleases(scope,function(releases){var startDate=releases[0].raw.ReleaseStartDate,endDate=releases[releases.length-1].raw.ReleaseDate;me.releaseList=releases;var featureConfig={autoLoad:!0,model:me.piTypes["0"],fetch:["Name","Release","ObjectID","FormattedID","PreliminaryEstimate","Value","Rank"],filters:[{property:"Release.ReleaseStartDate",operator:">=",value:startDate},{property:"Release.ReleaseDate",operator:"<=",value:endDate}]},storyConfig={autoLoad:!0,model:"HierarchicalRequirement",fetch:["Name","Release",me.featureField,"ObjectID","PlanEstimate","InProgressDate","AcceptedDate"],filters:[{property:me.featureField+".Release.ReleaseStartDate",operator:">=",value:startDate},{property:me.featureField+".Release.ReleaseDate",operator:"<=",value:endDate},{property:"DirectChildrenCount",value:"0"}]};me.createChart([featureConfig,storyConfig])})},_queryForReleases:function(scope,callback){var me=this,query,requestedReleases=[],processedReleases=[],numReleaseReqs=0,preRels=parseInt(""+me.getSetting("includeBefore"),10)||0,supRels=parseInt(""+me.getSetting("includeAfter"),10)||0,doProcess=function(records,operator,success){console.log("doProcess:arguments",arguments);var rels=[];records&&processedReleases.push(records),processedReleases.length===numReleaseReqs&&(rels=rels.concat.apply(rels,processedReleases),rels.push(scope.getRecord()),rels.sort(function(a,b){var da=Rally.util.DateTime.fromIsoString(a.raw.ReleaseStartDate),db=Rally.util.DateTime.fromIsoString(b.raw.ReleaseStartDate);return Rally.util.DateTime.getDifference(da,db,"day")}),callback(rels))};preRels&&(numReleaseReqs++,requestedReleases.push(Ext.create("Rally.data.WsapiDataStore",{model:"Release",pageSize:preRels,remoteFilter:!0,remoteSort:!0,context:{projectScopeUp:!1,projectScopeDown:!1},sorters:[{property:"ReleaseStartDate",direction:"DESC"}],filters:[{property:"ReleaseStartDate",operator:"<",value:me._getStartDate(scope.getRecord())}]}))),supRels&&(numReleaseReqs++,requestedReleases.push(Ext.create("Rally.data.WsapiDataStore",{model:"Release",pageSize:supRels,remoteFilter:!0,remoteSort:!0,context:{projectScopeUp:!1,projectScopeDown:!1},sorters:[{property:"ReleaseStartDate",direction:"ASC"}],filters:[{property:"ReleaseDate",operator:">",value:me._getEndDate(scope.getRecord())}]}))),Ext.Array.each(requestedReleases,function(rr){rr.loadPage(1,{scope:me,callback:doProcess})}),preRels||supRels||doProcess()},createChart:function(storeConfig){var me=this,subtitle=Ext.Array.map(me.releaseList,function(release){return release.raw.Name}).join(", "),labelConfig={formatter:function(){var parts=this.value.split("::"),oid=parts[0],fid=parts[1],name=parts[2],len=parseInt(""+me.getSetting("truncateStringLength"),10);return!isNaN(len)&&len>0&&(name=Ext.util.Format.ellipsis(name,len,!0)),fid+": "+name}};me.getSetting("rotateLabels")&&(labelConfig.rotation=-45,labelConfig.align="right"),me.removeAll(!0),chart=Ext.create("Rally.ui.chart.Chart",{storeType:"Rally.data.WsapiDataStore",storeConfig:storeConfig,calculatorType:"FeatureProfileCalculator",calculatorConfig:{costPerPoint:me.getSetting("costPerPoint"),featureField:me.featureField},chartColors:["#2ecc71","#f1c40f","#95a5a6","#3498db","#e74c3c","#e67e22"],chartConfig:{layout:"fit",chart:{type:"column",zoomType:"x",height:me.getHeight(),width:me.getWidth()},plotOptions:{column:{stacking:"normal"}},title:{text:"Feature Profile"},subtitle:{text:subtitle},tooltip:{formatter:function(){var parts=this.key.split("::"),value=this.y;return-1!==this.series.name.indexOf("Cost")&&(value=Ext.util.Format.currency(value)+" ("+parseInt(""+value,10)/parseInt(me.getSetting("costPerPoint"),10)+" SP)"),'<span style="font-size: 10px">'+parts[1]+": "+parts[2]+"</span><br/>"+'<span style="color:'+this.series.color+'">'+this.series.name+"</span>: <b>"+value+"</b><br/>"}},xAxis:{title:{text:"Features"},labels:labelConfig},yAxis:[{min:0,title:{text:"Points"}},{title:{text:"Estimated Cost"},min:0,opposite:!0,labels:{formatter:function(){return Ext.util.Format.currency(this.value)}}}]}});var container={xtype:"container",itemId:"container"};me.add(container),me.down("#container").add(chart)},_getStartDate:function(release){return release.raw.ReleaseStartDate},_getEndDate:function(release){return release.raw.ReleaseDate}});
                var __sumArray=function(arr,filterFn){var sum=0,holder;return filterFn||(filterFn=function(){return!0}),Ext.Array.each(arr,function(itm){filterFn(itm)&&(holder=parseInt(""+itm.PlanEstimate,10),!isNaN(holder)&&holder&&(sum+=holder))}),sum},__sumStories=function(storiesByFeature,filterFn){var map={};return Ext.Object.each(storiesByFeature,function(fid,stories){map[fid]=__sumArray(stories,filterFn)}),map};Ext.define("FeatureProfileCalculator",{extend:"Rally.data.lookback.calculator.BaseCalculator",prepareChartData:function(stores){var snapshots=[];return Ext.Array.each(stores,function(store){store.each(function(record){snapshots.push(record.raw)})}),this.runCalculation(snapshots)},_mapFeatures:function(records){var map={};return Ext.Array.each(records,function(record){-1!==record._type.toLowerCase().indexOf("portfolioitem")&&(map[record.ObjectID]=record)}),map},_sortFeaturesByRank:function(featureMap){var rank=Ext.Object.getKeys(featureMap);return rank.sort(function(a,b){return featureMap[a].Rank-featureMap[b].Rank}),rank},_hydrate:function(arr,map){var ret=[];return Ext.Array.each(arr,function(itm){ret.push(map[itm])}),ret},_groupStoriesByFeature:function(records){var map={},featureField=this.featureField;return Ext.Array.each(records,function(record){"hierarchicalrequirement"===record._type.toLowerCase()&&record[featureField]&&(console.log("Feature",featureField,record),map[record[featureField].ObjectID]=map[record[featureField].ObjectID]||[],map[record[featureField].ObjectID].push(record))}),map},_sumPreIPStories:function(storiesByFeature){var filterFn=function(s){return Ext.isEmpty(s.InProgressDate)};return __sumStories(storiesByFeature,filterFn)},_sumIPStories:function(storiesByFeature){var filterFn=function(s){return!Ext.isEmpty(s.InProgressDate)&&Ext.isEmpty(s.AcceptedDate)};return __sumStories(storiesByFeature,filterFn)},_sumAcceptedStories:function(storiesByFeature){var filterFn=function(s){return!Ext.isEmpty(s.AcceptedDate)};return __sumStories(storiesByFeature,filterFn)},_sumAllStories:function(storiesByFeature){var filterFn=function(s){return!0};return __sumStories(storiesByFeature,filterFn)},runCalculation:function(records){var me=this,featureMap=me._mapFeatures(records),featureOrder=me._sortFeaturesByRank(featureMap),storiesByFeature=me._groupStoriesByFeature(records),notStartedStoryPointsByFeature=me._sumPreIPStories(storiesByFeature),inProgressStoryPointsByFeature=me._sumIPStories(storiesByFeature),acceptedStoryPointsByFeature=me._sumAcceptedStories(storiesByFeature),allStoryPoints=me._sumAllStories(storiesByFeature),notStartedSeries=[],inProgressSeries=[],featureSeries=[],acceptedSeries=[],allSeries=[],featureCostSeries=[],series=[],categories=[];return Ext.Array.each(featureOrder,function(fid){var where=allSeries.length-1,storyCost,featureCost,featurePoints=featureMap[fid].PreliminaryEstimate&&featureMap[fid].PreliminaryEstimate.Value||0;categories.push(""+featureMap[fid].ObjectID+"::"+featureMap[fid].FormattedID+"::"+featureMap[fid].Name),notStartedSeries.push(notStartedStoryPointsByFeature[fid]||0),inProgressSeries.push(inProgressStoryPointsByFeature[fid]||0),acceptedSeries.push(acceptedStoryPointsByFeature[fid]||0),where>=0?(storyCost=allSeries[where]+(allStoryPoints[fid]||0)*me.costPerPoint,featureCost=featureCostSeries[where]+featurePoints*me.costPerPoint):(storyCost=(allStoryPoints[fid]||0)*me.costPerPoint,featureCost=featurePoints*me.costPerPoint),allSeries.push(storyCost),featureSeries.push(featurePoints),featureCostSeries.push(featureCost)}),series.push({yAxis:0,type:"column",name:"Accepted",stack:"story",data:acceptedSeries}),series.push({yAxis:0,type:"column",name:"InProgress",stack:"story",data:inProgressSeries}),series.push({yAxis:0,type:"column",name:"Not Started",stack:"story",data:notStartedSeries}),series.push({yAxis:0,type:"column",name:"Feature Points",stack:"feature",data:featureSeries}),series.push({yAxis:1,type:"spline",name:"Cumulative Cost",data:allSeries}),series.push({yAxis:1,type:"spline",name:"Cumulative Feature Cost",data:featureCostSeries}),{categories:categories,series:series}}});

            Rally.launchApp('CustomApp', {
                name:"FeatureProfile",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
